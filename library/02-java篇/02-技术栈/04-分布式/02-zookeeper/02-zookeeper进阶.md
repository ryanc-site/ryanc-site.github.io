# zookeeperè¿›é˜¶

> æ—¶é—´ï¼š<span style="color:#42B983;font-weight:bold;">2021å¹´05æœˆ02æ—¥17:09:24</span>

## ä¸€ã€æºç è§£æ

### 1ã€æºç ä¸‹è½½



### 2ã€å¯åŠ¨æµç¨‹



### 3ã€é€‰ä¸»æµç¨‹



### 4ã€watcheræœºåˆ¶



## äºŒã€zkåº”ç”¨åœºæ™¯

### 1ã€é…ç½®ä¸­å¿ƒ

#### â˜› åœºæ™¯ & éœ€æ±‚

<span style="color:#42B983;font-weight:bold;">ç®€è¿°ï¼š</span>é›†ç¾¤ä¸Šæœ‰å¾ˆå¤šä¸ªèŠ‚ç‚¹è¿è¡ŒåŒä¸€ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡ä¼šæœ‰ä¸€äº›å¯èƒ½ç»å¸¸æ”¹å˜çš„é…ç½®å‚æ•°</br>
è¦æ±‚æ˜¯å½“é…ç½®å‚æ•°æ”¹å˜ä¹‹åèƒ½å¤Ÿå¾ˆå¿«åœ°åŒæ­¥åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Š</br>
å¦‚æœå°†è¿™äº›é…ç½®å‚æ•°æ”¾åœ¨æœ¬åœ°æ–‡ä»¶ä¸­åˆ™æ¯æ¬¡éƒ½è¦ä¿®æ”¹æœ¬åœ°æ–‡ä»¶è´¹æ—¶è´¹åŠ›è¿˜å¯èƒ½ä¼šæœ‰é—æ¼</br>
æ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¸€ä¸ªæ¯”è¾ƒè‡ªç„¶çš„æƒ³æ³•å°±æ˜¯å°†é…ç½®å•ç‹¬æå–å‡ºæ¥ä½œä¸ºä¸€ä¸ªæœåŠ¡</br>



#### â˜›  é€‰å‹åˆ†æ

* <span style="color:#42B983;font-weight:bold;">é…ç½®ä¸­å¿ƒçš„æ ¸å¿ƒ</span>

  * <span style="color:#FC5531; font-weight:bold;"> ä½å»¶æ—¶ï¼š</span> <span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">é…ç½®æ”¹å˜åèƒ½å¤Ÿå°½å¿«çš„å°†æœ€æ–°é…ç½®åŒæ­¥ç»™æ¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚</span>
  * <span style="color:#FC5531; font-weight:bold;"> é«˜å¯ç”¨ï¼š</span> <span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">é…ç½®ä¸­å¿ƒéœ€è¦èƒ½å¤Ÿç¨³å®šä¸é—´æ–­çš„æä¾›æœåŠ¡ã€‚</span>

* <span style="color:#42B983;font-weight:bold;">é…ç½®ä¸­å¿ƒå®ç°</span>

  <span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;">å‘å¸ƒ/è®¢é˜…ç³»ç»Ÿä¸€èˆ¬æœ‰ä¸¤ç§è®¾è®¡æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯æ¨(Push)æ¨¡å¼å’Œæ‹‰(Pull)æ¨¡å¼ã€‚</span>

  * <span style="color:#FC5531; font-weight:bold;"> æ¨æ¨¡å¼ï¼š</span><span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">æœåŠ¡ç«¯ä¸»åŠ¨å°†æ•°æ®æ›´æ–°å‘é€ç»™æ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯ã€‚</span>
  * <span style="color:#FC5531; font-weight:bold;"> æ‹‰æ¨¡å¼ï¼š</span><span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">å®¢æˆ·ç«¯é€šè¿‡é‡‡ç”¨å®šæ—¶è½®è¯¢æ‹‰å–ã€‚</span>



#### â˜› å®ç°åˆ†æ

<span style="color:#42B983;font-weight:bold;">åˆ†æï¼š</span> ZooKeeperé‡‡ç”¨çš„æ˜¯æ¨æ‹‰ç›¸ç»“åˆçš„æ–¹å¼ï¼š</br>

å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æ³¨å†Œè‡ªå·±éœ€è¦å…³æ³¨çš„èŠ‚ç‚¹ï¼Œä¸€æ—¦è¯¥èŠ‚ç‚¹çš„æ•°æ®å‘ç”Ÿå˜æ›´ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯å°±ä¼šå‘ç›¸åº”çš„å®¢æˆ·ç«¯å‘é€Watcheräº‹ä»¶é€šçŸ¥ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯é€šçŸ¥ä¹‹åï¼Œéœ€è¦ä¸»åŠ¨åˆ°æœåŠ¡ç«¯è·å–æœ€æ–°çš„æ•°æ®ã€‚ </br>

å¦‚æœå°†é…ç½®ä¿¡æ¯å­˜æ”¾åˆ°ZKä¸Šè¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œé‚£ä¹ˆé€šå¸¸æƒ…å†µä¸‹ï¼Œåº”ç”¨åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šä¸»åŠ¨åˆ°ZKæœåŠ¡å™¨ä¸Šè¿›è¡Œä¸€æ¬¡é…ç½®ä¿¡æ¯çš„è·å–ï¼ŒåŒæ—¶ï¼Œåœ¨æŒ‡å®šä¸Šæ³¨å†Œä¸€ä¸ªWatcherç›‘å¬ï¼Œè¿™æ ·ä¸€æ¥ï¼Œä½†å‡¡é…ç½®ä¿¡æ¯å‘ç”Ÿå˜æ›´ï¼ŒæœåŠ¡å™¨éƒ½ä¼šå®æ—¶é€šçŸ¥æ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯ï¼Œä»è€Œè¾¾åˆ°å®æ—¶è·å–æœ€æ–°é…ç½®ä¿¡æ¯çš„ç›®çš„ã€‚</br>

![image-20210502195628408](amWiki/images/lib_img/image-20210502195628408.png)

* <span style="color:#FC5531; font-weight:bold;"> é…ç½®ä¿¡æ¯ç‰¹æ€§</span>

  * æ•°æ®é‡é€šå¸¸æ¯”è¾ƒå°
  * æ•°æ®å†…å®¹åœ¨è¿è¡Œæ—¶ä¼šå‘ç”Ÿå˜åŒ–
  * é›†ç¾¤ä¸­å„æœºå™¨å…±äº«ã€é…ç½®ä¸€è‡´

* <span style="color:#FC5531; font-weight:bold;"> é…ç½®å­˜å‚¨</span>

  åœ¨è¿›è¡Œé…ç½®ç®¡ç†ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å°†åˆå§‹åŒ–é…ç½®å­˜å‚¨åˆ°ZKä¸Šå»ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ZKä¸Šé€‰å–ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ç”¨äºé…ç½®çš„å­˜å‚¨ï¼Œæˆ‘ä»¬å°†éœ€è¦é›†ä¸­ç®¡ç†çš„é…ç½®ä¿¡æ¯å†™å…¥åˆ°è¯¥æ•°æ®èŠ‚ç‚¹ä¸­å»ã€‚

* <span style="color:#FC5531; font-weight:bold;"> é…ç½®è·å–</span>

  é›†ç¾¤ä¸­æ¯å°æœºå™¨åœ¨å¯åŠ¨åˆå§‹åŒ–é˜¶æ®µï¼Œé¦–å…ˆä¼šä»ä¸Šé¢æåˆ°çš„ZKçš„é…ç½®èŠ‚ç‚¹ä¸Šè¯»å–æ•°æ®åº“ä¿¡æ¯ï¼ŒåŒæ—¶ï¼Œå®¢æˆ·ç«¯è¿˜éœ€è¦åœ¨è¯¥é…ç½®èŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€ä¸ªæ•°æ®å˜æ›´çš„Watcherç›‘å¬ï¼Œä¸€æ—¦å‘ç”ŸèŠ‚ç‚¹æ•°æ®å˜æ›´ï¼Œæ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯éƒ½èƒ½å¤Ÿè·å–æ•°æ®å˜æ›´é€šçŸ¥ã€‚

* <span style="color:#FC5531; font-weight:bold;"> é…ç½®å˜æ›´</span>

  åœ¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°éœ€è¦è¿›è¡Œæ•°æ®åˆ‡æ¢çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿›è¡Œé…ç½®å˜æ›´ã€‚å€ŸåŠ©ZKï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹ZKä¸Šé…ç½®èŠ‚ç‚¹çš„å†…å®¹è¿›è¡Œæ›´æ–°ï¼ŒZKå°±èƒ½å¤Ÿå¸®æˆ‘ä»¬å°†æ•°æ®å˜æ›´çš„é€šçŸ¥å‘é€åˆ°å„ä¸ªå®¢æˆ·ç«¯ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°è¿™ä¸ªå˜æ›´é€šçŸ¥åï¼Œå°±å¯ä»¥é‡æ–°è¿›è¡Œæœ€æ–°æ•°æ®çš„è·å–ã€‚

#### â˜›ä»£ç å®ç°

<span style="color:#42B983;font-weight:bold;">ç®€è¿°ï¼š</span> <span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;">ä»£ç åŒ…æ‹¬å¦‚ä¸‹ä¸‰ä¸ªéƒ¨åˆ†:é…ç½®å®¢æˆ·ç«¯ç±»ConfigClientã€åº”ç”¨æœåŠ¡ç±»Serviceã€æœ¬åœ°é…ç½®ç±»MyConfig,å…³ç³»å¦‚ä¸‹ï¼š</span></br>

<span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">ConfigClienté€šè¿‡ä¸zookeeperæœåŠ¡å™¨äº¤äº’ï¼Œä¿®æ”¹MyConfigï¼›</span></br>

<span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">Serviceåœ¨ä¸šåŠ¡é€»è¾‘ä¸­ç›´æ¥ä½¿ç”¨MyConfigï¼›</span> </br>

<span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">Serviceå¯åŠ¨æ—¶ï¼Œå®ŒæˆConfigClientçš„å¯åŠ¨ã€åˆå§‹åŒ–ã€‚</span> </br>

* <span style="color:#FC5531; font-weight:bold;">å®¢æˆ·ç«¯ç±»ConfigClient</span>

~~~ java
import org.apache.zookeeper.*;
import org.apache.zookeeper.data.Stat;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
 
import java.io.IOException;
import java.lang.reflect.Field;
import java.util.HashMap;
import java.util.Map;
 
/**
 * +--------------------------------+ <br>
 * | Even in a galaxy far,far away.  | <br>
 * | å³ä½¿æ˜¯åœ¨é¥è¿œçš„æ˜Ÿæ²³é‡Œä¹Ÿä¸€æ ·  !      |<br>
 * +--------------------------------+ <br>
 * @author ryan
 * @date May 2, 2021
 * @desc 
 * 		å®é™…ç”Ÿäº§ä¸­ï¼Œé…ç½®ä¸­å¿ƒçš„å®¢æˆ·ç«¯ä»¥javaæ³¨è§£çš„å½¢å¼ä½¿ç”¨
 * 		é€šè¿‡mavenå¼•å…¥ä¾èµ–ï¼Œéšç€æœåŠ¡çš„å¯åŠ¨ï¼Œspringå®¹å™¨è‡ªåŠ¨åŠ è½½
 *
 */
public class ConfigClient {
 
    private static final Logger log = LoggerFactory.getLogger(ConfigClient.class);
 
    private ZooKeeper zkClient;
 
    private String servicePath;
 
    private Map<String, String> localConfigs;
 
    /**
     * æœåŠ¡å¯åŠ¨æ—¶è°ƒç”¨ï¼Œå°†æœåŠ¡èŠ‚ç‚¹è®°å½•åˆ°/config-centerèŠ‚ç‚¹ä¸‹
     */
    public void init(String appkey) throws IOException {
        zkClient = new ZooKeeper("192.168.8.124:2181", 15000,
                event -> log.info("event:{}", event));
        this.servicePath = "/config-center/" + appkey;
        createNode(servicePath, new byte[0]);
        localConfigs = new HashMap<>(10);
    }
 
    /**
     * æ³¨æ„ï¼Œè°ƒç”¨createæ—¶ï¼Œdataè¿˜è¢«å½“åšä¸Šä¸‹æ–‡å‚æ•°ctxçš„å€¼ï¼›åœ¨å¼‚æ­¥å›è°ƒæ—¶ï¼Œå¦‚æœå‘ç”ŸconnectionLossï¼Œctxå¯ä»¥ä½œä¸ºdataå†æ¬¡è°ƒç”¨createæ–¹æ³•
     */
    private void createNode(String path, byte[] data) {
        zkClient.create(path, data, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT, new AsyncCallback.StringCallback() {
            @Override
            public void processResult(int rc, String path, Object ctx, String name) {
                switch (KeeperException.Code.get(rc)) {
                    case CONNECTIONLOSS:
                        createNode(path, (byte[]) ctx);
                        break;
                    case OK:
                        log.info("{} create successfully!", path);
                        break;
                    case NODEEXISTS:
                        log.info("{} exists!", path);
                        break;
                    default:
                        log.error("Something went wrong: ", KeeperException.create(KeeperException.Code.get(rc), path));
                }
            }
        }, data);
    }
 
    /**
     * æœåŠ¡å¯åŠ¨æ—¶è°ƒç”¨ï¼Œå°†æœ¬åœ°çš„æ¯ä¸ªé…ç½®é¡¹ä½œä¸ºèŠ‚ç‚¹ï¼Œè®°å½•åˆ°æœåŠ¡èŠ‚ç‚¹ä¸‹
     */
    public void registerConfig(String fieldName, Object configValue) {
        byte[] data = configValue == null ? new byte[0] : configValue.toString().getBytes();
        String configPath = this.servicePath + "/" + fieldName;
        createNode(configPath, data);
        localConfigs.put(configPath, fieldName);
        reloadConfig(configPath);
    }
 
    /**
     * DataCallbackï¼šå¼‚æ­¥æ–¹å¼æŸ¥è¯¢æ•°æ®ï¼Œå¦‚æœè¿æ¥ä¸¢å¤±ï¼Œé‡æ–°æ‰§è¡ŒreloadConfig
     * Watcherï¼šç›‘å¬èŠ‚ç‚¹æ•°æ®å˜æ›´ï¼Œå³ç›‘å¬é…ç½®çš„å€¼å‘ç”Ÿå˜æ›´
     */
    public void reloadConfig(String configPath) {
        zkClient.getData(configPath, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                switch (event.getType()) {
                    case NodeDataChanged:
                        log.info("æ•°æ®ä¿®æ”¹äº‹ä»¶å‘ç”Ÿ:{}", event.getPath());
                        reloadConfig(event.getPath());
                }
            }
        }, new AsyncCallback.DataCallback() {
            @Override
            public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {
                switch (KeeperException.Code.get(rc)) {
                    case CONNECTIONLOSS:
                        reloadConfig(path);
                    case OK:
                        String fieldName = localConfigs.get(path);
                        String strValue = new String(data);
                        reloadValue(fieldName, strValue);
                }
 
            }
        }, new Stat());
    }
 
    /**
     * é€šè¿‡åå°„çš„æ–¹å¼ï¼Œå°†é…ç½®çš„å˜æ›´setåˆ°åº”ç”¨æœåŠ¡çš„MyConfigç±»çš„å¯¹åº”fieldä¸­
     * å®é™…ç”Ÿäº§ä¸­ï¼Œä¾æ‰˜é…ç½®ä¸­å¿ƒçš„å®¢æˆ·ç«¯fieldçº§æ³¨è§£ï¼šä¸å¿…å°†æ‰€æœ‰é…ç½®ç»Ÿä¸€å†™åˆ°ç‰¹å®šçš„ç±»ä¸­ï¼›é…ç½®é¡¹åç§°ä¸å¿…ä¸å­—æ®µåç§°fieldNameç›¸åŒ
     */
    private void reloadValue(String fieldName, String strValue) {
        try {
            Field field = MyConfig.class.getDeclaredField(fieldName);
            field.setAccessible(true);
            if (field.getType() == String.class) {
                field.set(MyConfig.getInstance(), strValue);
            } else if (field.getType() == Integer.class) {
                field.set(MyConfig.getInstance(), Integer.valueOf(strValue));
            }
        } catch (IllegalAccessException e) {
            log.error("reload zk config to local config fail:", e);
        } catch (NoSuchFieldException e) {
            log.error("reload zk config to local config fail:", e);
        }
    }
}
~~~



* <span style="color:#FC5531; font-weight:bold;">åº”ç”¨æœåŠ¡ç±»Service</span>

~~~java
import org.apache.log4j.BasicConfigurator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
 
import java.io.IOException;
import java.util.Scanner;
 
/**
 * +--------------------------------+ <br>
 * | Even in a galaxy far,far away.  | <br>
 * | å³ä½¿æ˜¯åœ¨é¥è¿œçš„æ˜Ÿæ²³é‡Œä¹Ÿä¸€æ ·  !      |<br>
 * +--------------------------------+ <br>
 * @author ryan
 * @date May 2, 2021
 * @desc æœåŠ¡ç±»
 *
 */
public class Service {
 
    private static final Logger log = LoggerFactory.getLogger(ConfigClient.class);
 
    /**
     * æœåŠ¡å”¯ä¸€æ ‡è¯†
     */
    private String appkey = "service-1";
    private ConfigClient configClient;
    /**
     * åº”ç”¨æœåŠ¡åˆå§‹åŒ–
     * åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œé€šè¿‡springå®ŒæˆconfigClientçš„åˆå§‹åŒ–ã€ä¾èµ–æ³¨å…¥
     */
    public void init() throws IOException {
        configClient = new ConfigClient();
        configClient.init(appkey);
        configClient.registerConfig("whiteList", MyConfig.getInstance().whiteList);
        configClient.registerConfig("limit", MyConfig.getInstance().limit);
    }
    public static void main(String[] args) {
    	BasicConfigurator.configure();
        Service service = new Service();
        try {
            service.init();
            Thread.sleep(2000);
        } catch (Exception e) {
        	log.error("start fail....");
            System.exit(-1);
        }
        Scanner sc = new Scanner(System.in);
        while (true) {
            log.info("å›è½¦æŸ¥çœ‹å½“å‰é…ç½®ï¼š");
            sc.nextLine();
            log.info("service config whiteList: {}, limit:{}", MyConfig.getInstance().getWhiteList(),
                    MyConfig.getInstance().limit);
        }
    }
}
~~~



* <span style="color:#FC5531; font-weight:bold;">æœ¬åœ°é…ç½®ç±»MyConfig</span>

~~~java
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
 
/**
 * +--------------------------------+ <br>
 * | Even in a galaxy far,far away.  | <br>
 * | å³ä½¿æ˜¯åœ¨é¥è¿œçš„æ˜Ÿæ²³é‡Œä¹Ÿä¸€æ ·  !      |<br>
 * +--------------------------------+ <br>
 * @author ryan
 * @date May 2, 2021
 * @desc 
 * 		å®é™…ç”Ÿäº§ä¸­ï¼š
 * 			â‘  myConfigå¯ä»¥ä½œä¸ºå•ä¾‹beanæ‰˜ç®¡åœ¨springå®¹å™¨ä¸­
 * 			â‘¡ åˆ©ç”¨java fieldçº§æ³¨è§£ï¼Œä¸å¿…å°†æ¯ä¸€é¡¹é…ç½®ç»Ÿä¸€å†™åˆ°ç‰¹å®šç±»ä¸­ï¼Œ
 *
 */
public class MyConfig {
 
    private volatile static MyConfig instance;
 
    private MyConfig() {
    }
 
    /**
     * å•ä¾‹æ¨¡å¼ï¼šå»¶è¿ŸåŠ è½½ä¸åŒé‡æ£€æŸ¥é”å®š
     */
    public static MyConfig getInstance() {
        if (instance == null) {
            synchronized (MyConfig.class) {
                if (instance == null) {
                    instance = new MyConfig();
                }
            }
        }
        return instance;
    }
 
    /**
     * é…ç½®1ï¼šç™½åå•åˆ—è¡¨
     */
    public String whiteList = "lileim,hanmeimei";
 
    public List<String> getWhiteList() {
        try {
            return new ArrayList(Arrays.asList(whiteList.split(",")));
        } catch (Exception e) {
            return new ArrayList<>();
        }
    }
 
    /**
     * é…ç½®2ï¼šé™åˆ¶
     */
    public Integer limit = 10;
 
}
~~~



###  2ã€è´Ÿè½½å‡è¡¡



### 3ã€å‘½åæœåŠ¡



### 4ã€DNSæœåŠ¡



### 5ã€é›†ç¾¤ç®¡ç†



### 6ã€åˆ†å¸ƒå¼é”

#### â˜›  åœºæ™¯ & éœ€æ±‚

<span style="color:#42B983;font-weight:bold;">ç®€è¿°ï¼š</span> åœ¨åˆ†å¸ƒå¼å¾®æœåŠ¡åœºæ™¯ä¸­ï¼ŒåŒä¸€ä¸ªå¾®æœåŠ¡çš„å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å¯¹èµ„æºè¿›è¡Œæ“ä½œæ—¶å°±ä¼šæœ‰åˆ†å¸ƒå¼åŒæ­¥é—®é¢˜ï¼ˆç±»ä¼¼äºå¤šçº¿ç¨‹æ“ä½œèµ„æºåœºæ™¯ï¼‰

#### â˜›  é€‰å‹åˆ†æ

<span style="color:#42B983;font-weight:bold;">åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒ</span>

* <span style="color:#FC5531; font-weight:bold;"> ç‹¬å ï¼š</span> <span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">ä»»ä½•æ—¶å€™åªèƒ½æœ‰ä¸ªå¾®æœåŠ¡è·å–åˆ°è¯¥é”</span>
* <span style="color:#FC5531; font-weight:bold;"> æ—¶åºæ€§ï¼š</span> <span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">æ‰€æœ‰å‚ä¸è·å–é”çš„å¾®æœåŠ¡éƒ½ä¼šè¢«å®‰æ’æ‰§è¡Œ</span>

#### â˜› å®ç°åˆ†æ

<span style="color:#42B983;font-weight:bold;">å®ç°æ€è·¯ï¼š</span> ä¸ºæ¯ä¸€ä¸ªæ‰§è¡Œçš„å®¢æˆ·ç«¯éƒ½åˆ›å»ºä¸€ä¸ªæœ‰åºä¸´æ—¶èŠ‚ç‚¹ï¼›æ¯ä¸ªå®¢æˆ·ç«¯éƒ½åˆ¤æ–­è‡ªå·±çš„ä¸´æ—¶èŠ‚ç‚¹åºå·æ˜¯ä¸æ˜¯æœ€å°çš„ï¼š

* åºå·æœ€å°ï¼šåˆ™è·å–é”æ‰§è¡Œç›¸å…³æ“ä½œï¼Œé‡Šæ”¾é”ï¼ˆåˆ é™¤èŠ‚ç‚¹ï¼‰
* åºå·éæœ€å°ï¼šåˆ™ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå½“å‰ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤æ—¶ï¼Œè·å–é”ï¼Œä¸€æ¬¡ç±»æ¨

![image-20210502194804999](amWiki/images/lib_img/image-20210502194804999.png)

#### â˜› ä»£ç å®ç°

<span style="color:#42B983;font-weight:bold;">ç®€è¿°ï¼š</span> <span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;">ä»£ç åŒ…æ‹¬å¦‚ä¸‹ä¸‰ä¸ªéƒ¨åˆ†:åˆ†å¸ƒå¼é”å·¥å…·ç±»ZkLockã€åº“å­˜æ•°æ®æ¨¡å‹stockã€åˆ†å¸ƒå¼é”æµ‹è¯•StockMain,å…³ç³»å¦‚ä¸‹ï¼š</span></br>

<span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">ZkLocké€šè¿‡å®ç°Lockå¯¹å¤–æä¾›lock API</span></br>

<span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">stock åº“å­˜æ•°æ®æ¨¡å‹ï¼Œè§’è‰²å…±äº«èµ„æº</span> </br>

<span style=" font-weight:bold;border-bottom:1px dashed #000; height:50px;width:350px;color:#0081EF">StockMain ç”¨å¤šçº¿ç¨‹æ¨¡æ‹Ÿåˆ†å¸ƒå¼åœºæ™¯ï¼Œæµ‹è¯•åˆ†å¸ƒå¼é”</span> </br>

* ZkLock

~~~java
import org.apache.zookeeper.*;
import org.apache.zookeeper.data.Stat;
import java.util.List;
import java.util.TreeSet;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;


/**
 * +--------------------------------+ <br>
 * | Even in a galaxy far,far away.  | <br>
 * | å³ä½¿æ˜¯åœ¨é¥è¿œçš„æ˜Ÿæ²³é‡Œä¹Ÿä¸€æ ·  !      |<br>
 * +--------------------------------+ <br>
 * @author ryan
 * @date May 2, 2021
 * @desc åŸºäºzk å®ç°çš„åˆ†å¸ƒå¼é”
 *
 */
public class ZkLock implements Lock {


    //zkå®¢æˆ·ç«¯
    private ZooKeeper zk;
    //zkæ˜¯ä¸€ä¸ªç›®å½•ç»“æ„ï¼Œlocks
    private String root = "/locks";
    //é”çš„åç§°
    private String lockName;
    //å½“å‰çº¿ç¨‹åˆ›å»ºçš„åºåˆ—node
    private ThreadLocal<String> nodeId = new ThreadLocal<>();
    //ç”¨æ¥åŒæ­¥ç­‰å¾…zkclienté“¾æ¥åˆ°äº†æœåŠ¡ç«¯
    private CountDownLatch connectedSignal = new CountDownLatch(1);
    private final static int sessionTimeout = 3000;
    private final static byte[] data= new byte[0];


    public ZkLock(String config, String lockName) {
        this.lockName = lockName;

        try {
            zk = new ZooKeeper(config, sessionTimeout, new Watcher() {

                @Override
                public void process(WatchedEvent event) {
                    // å»ºç«‹è¿æ¥
                    if (event.getState() == Event.KeeperState.SyncConnected) {
                        connectedSignal.countDown();
                    }
                }

            });

            connectedSignal.await();
            Stat stat = zk.exists(root, false);
            if (null == stat) {
                // åˆ›å»ºæ ¹èŠ‚ç‚¹
                zk.create(root, data, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
            }
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    class LockWatcher implements Watcher {
        private CountDownLatch latch = null;

        public LockWatcher(CountDownLatch latch) {
            this.latch = latch;
        }

        @Override
        public void process(WatchedEvent event) {

            if (event.getType() == Event.EventType.NodeDeleted)
                latch.countDown();
        }
    }

    @Override
    public void lock() {
        try {
            // åˆ›å»ºä¸´æ—¶å­èŠ‚ç‚¹
            String myNode = zk.create(root + "/" + lockName , data, ZooDefs.Ids.OPEN_ACL_UNSAFE,
                    CreateMode.EPHEMERAL_SEQUENTIAL);

            System.out.println(Thread.currentThread().getName()+myNode+ "created");

            // å–å‡ºæ‰€æœ‰å­èŠ‚ç‚¹
            List<String> subNodes = zk.getChildren(root, false);
            TreeSet<String> sortedNodes = new TreeSet<>();
            for(String node :subNodes) {
                sortedNodes.add(root +"/" +node);
            }

            String smallNode = sortedNodes.first();


            if (myNode.equals( smallNode)) {
                // å¦‚æœæ˜¯æœ€å°çš„èŠ‚ç‚¹,åˆ™è¡¨ç¤ºå–å¾—é”
                System.out.println(Thread.currentThread().getName()+ myNode+"get lock");
                this.nodeId.set(myNode);
                return;
            }

            String preNode = sortedNodes.lower(myNode);

            CountDownLatch latch = new CountDownLatch(1);
            Stat stat = zk.exists(preNode, new LockWatcher(latch));// åŒæ—¶æ³¨å†Œç›‘å¬ã€‚
            // åˆ¤æ–­æ¯”è‡ªå·±å°ä¸€ä¸ªæ•°çš„èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨,å¦‚æœä¸å­˜åœ¨åˆ™æ— éœ€ç­‰å¾…é”,åŒæ—¶æ³¨å†Œç›‘å¬
            if (stat != null) {
                System.out.println(Thread.currentThread().getName()+myNode+
                        " waiting for " + root + "/" + preNode + " released lock");

                latch.await();// ç­‰å¾…ï¼Œè¿™é‡Œåº”è¯¥ä¸€ç›´ç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”
                nodeId.set(myNode);
                latch = null;
            }
        } catch (Exception e) {
            throw new RuntimeException(e);
        }

    }


    @Override
    public void unlock() {
        try {
            System.out.println(Thread.currentThread().getName()+ "unlock ");
            if (null != nodeId) {
                zk.delete(nodeId.get(), -1);
            }
            nodeId.remove();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (KeeperException e) {
            e.printStackTrace();
        }
    }



    @Override
    public void lockInterruptibly() throws InterruptedException {

    }

    @Override
    public boolean tryLock() {
        return false;
    }

    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return false;
    }



    @Override
    public Condition newCondition() {
        return null;
    }
}

~~~

* Stock

~~~java
/**
 * +--------------------------------+ <br>
 * | Even in a galaxy far,far away.  | <br>
 * | å³ä½¿æ˜¯åœ¨é¥è¿œçš„æ˜Ÿæ²³é‡Œä¹Ÿä¸€æ ·  !      |<br>
 * +--------------------------------+ <br>
 * @author ryan
 * @date May 2, 2021
 * @desc åˆ†å¸ƒå¼é” æ¼”ç¤º æ•°æ®æ¨¡å‹
 *
 */
public class Stock {

    //åº“å­˜ä¸º1
    private static int num = 1;

    public static boolean reduseStock(){

        if(num>0){
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            num--;
            return true;
        }
         return false;
    }
}

~~~

* StockMain

~~~java

/**
 * +--------------------------------+ <br>
 * | Even in a galaxy far,far away.  | <br>
 * | å³ä½¿æ˜¯åœ¨é¥è¿œçš„æ˜Ÿæ²³é‡Œä¹Ÿä¸€æ ·  !      |<br>
 * +--------------------------------+ <br>
 * @author ryan
 * @date May 2, 2021
 * @desc åˆ†å¸ƒå¼é”æµ‹è¯•ç±»
 *
 */
public class StockMain {

    private static ZkLock zkLock;

    static{
        zkLock = new ZkLock("127.0.0.1:2181","stock_zk");
    }


    static class StockThread implements Runnable{

        @Override
        public void run() {

        	// ä¸Šé”
            zkLock.lock();

            // æ‰£å‡åº“å­˜
            boolean b = new Stock().reduseStock();

            // è§£é”
            zkLock.unlock();

            if(b){
                System.out.println(Thread.currentThread().getName()+":æ‰£å‡åº“å­˜æˆåŠŸï¼");
            }else{
                System.out.println(Thread.currentThread().getName()+":æ‰£å‡åº“å­˜å¤±è´¥ï¼");
            }
        }
    }

    public static void main(String[] args) {
        new Thread(new StockThread(),"ç”¨æˆ·1").start();
        new Thread(new StockThread(),"ç”¨æˆ·2").start();
    }
}

~~~



### 7ã€åˆ†å¸ƒå¼é˜Ÿåˆ—



## é™„å½•

### å‚è€ƒ

ğŸ‘‰ [zookeeper-é…ç½®ä¸­å¿ƒ](https://blog.csdn.net/ye201622021113/article/details/112760952)

